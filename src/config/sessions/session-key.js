import { buildAgentMainSessionKey, DEFAULT_AGENT_ID, normalizeMainKey } from "../../routing/session-key.js";
import { normalizeE164 } from "../../utils.js";
import { resolveGroupSessionKey } from "./group.js";
export function deriveSessionKey(scope, ctx) {
  if ((scope === "global")) {
    return "global";
  }
  const resolvedGroup = resolveGroupSessionKey(ctx);
  if (resolvedGroup) {
    return resolvedGroup.key;
  }
  const from = ctx.From ? normalizeE164(ctx.From) : "";
  return (from || "unknown");
}

export function resolveSessionKey(scope, ctx, mainKey) {
  const explicit = ctx.SessionKey?.trim();
  if (explicit) {
    return explicit.toLowerCase();
  }
  const raw = deriveSessionKey(scope, ctx);
  if ((scope === "global")) {
    return raw;
  }
  const canonicalMainKey = normalizeMainKey(mainKey);
  const canonical = buildAgentMainSessionKey({ agentId: DEFAULT_AGENT_ID, mainKey: canonicalMainKey });
  const isGroup = (raw.includes(":group:") || raw.includes(":channel:"));
  if (!isGroup) {
    return canonical;
  }
  return "agent::";
}

